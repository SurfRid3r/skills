# PCAP IP 提取 - 使用示例

## 目录

- [示例 1: HTTP 流量分析](#示例-1-http-流量分析)
- [示例 2: 加密流量分析](#示例-2-加密流量分析)
- [示例 3: 多协议流量分析](#示例-3-多协议流量分析)
- [示例 4: 多候选流分析](#示例-4-多候选流分析)

---

## 示例 1: HTTP 流量分析

**场景**: certutil 下载文件

**文件**: `certutil-download.pcap`

### 步骤 1: 列出所有流

```bash
python scripts/pcap_tools.py list certutil-download.pcap
```

**输出**:
```
# IP 流列表 (Top 20)

| 源 IP | 目的 IP | 字节数 | 数据包 | 端口 |
|-------|---------|--------|--------|------|
| 172.16.13.81 | 172.16.13.82 | 12345 | 500 | 49152->80 |
```

### 步骤 2: 分析端口判断协议

端口 `49152->80` 表示 HTTP 流量（目的端口 80）

### 步骤 3: 提取 payload 验证

```bash
# 提取特定 IP 流的 payload（端口 80）
python scripts/pcap_tools.py extract certutil-download.pcap 172.16.13.81 172.16.13.82 --dst-port 80

# 或者不指定端口，提取所有端口的 payload
python scripts/pcap_tools.py extract certutil-download.pcap 172.16.13.81 172.16.13.82
```

**输出**:
```
# 找到 1 个 TCP 流

## 流 1: `172.16.13.81:49152` → `172.16.13.82:80`

### 数据包 1

- **SEQ**: `1000`
- **ACK**: `0`

**Payload**:

```
GET /malware.exe HTTP/1.1
Host: 172.16.13.82
```

### 数据包 2

- **SEQ**: `2000`
- **ACK**: `1200`

**Payload**:

```
HTTP/1.1 200 OK
Content-Type: application/octet-stream
```
```

### 分析结论

- 文件名包含 "certutil"，推断为文件下载攻击
- 端口 80 确认为 HTTP
- Payload 显示 `GET /malware.exe`，确认是文件下载
- 方向: 客户端 → 服务器

**结果**: `172.16.13.81,172.16.13.82,certutil-download.pcap`

---

## 示例 2: 加密流量分析

**场景**: SSH 连接

**文件**: `ssh-connection.pcap`

### 步骤 1: 列出所有流

```bash
python scripts/pcap_tools.py list ssh-connection.pcap
```

**输出**:
```
# IP 流列表 (Top 20)

| 源 IP | 目的 IP | 字节数 | 数据包 | 端口 |
|-------|---------|--------|--------|------|
| 10.211.55.3 | 10.211.55.2 | 12345 | 500 | 54321->22 |
| 10.211.55.2 | 10.211.55.3 | 9876 | 300 | 22->54321 |
```

### 步骤 2: 分析端口判断协议

端口 `54321->22` 表示 SSH 流量（目的端口 22）

### 步骤 3: 验证流量方向

- 字节数最多的流是 `10.211.55.3 -> 10.211.55.2`
- SSH 连接通常由客户端发起
- 端口 22 是 SSH 标准端口

### 分析结论

- 端口 22 确认为 SSH
- 字节数最多的流是主连接
- 流量方向: 客户端 → 服务器

**结果**: `10.211.55.3,10.211.55.2,ssh-connection.pcap`

---

## 示例 3: 多协议流量分析

**场景**: SMB 横向移动

**文件**: `smb-adduser.pcap`

### 步骤 1: 列出所有流

```bash
python scripts/pcap_tools.py list smb-adduser.pcap
```

**输出**:
```
# IP 流列表 (Top 20)

| 源 IP | 目的 IP | 字节数 | 数据包 | 端口 |
|-------|---------|--------|--------|------|
| 172.16.13.42 | 172.16.13.41 | 8765 | 450 | 50123->445 |
| 172.16.13.42 | 172.16.13.41 | 234 | 20 | 50124->139 |
```

### 步骤 2: 分析端口判断协议

- 端口 `50123->445`: SMB（端口 445）
- 端口 `50124->139`: NetBIOS（背景流量，忽略）

### 步骤 3: 提取 payload 验证

```bash
# 提取特定 IP 流的 payload（端口 22）
python scripts/pcap_tools.py extract smb-adduser.pcap 172.16.13.42 172.16.13.41 --dst-port 445

# 或者不指定端口
python scripts/pcap_tools.py extract smb-adduser.pcap 172.16.13.42 172.16.13.41
```

**输出**:
```
# 找到 1 个 TCP 流

## 流 1: `172.16.13.42:50123` → `172.16.13.41:445`

### 数据包 1

- **SEQ**: `1000`
- **ACK**: `0`

**Payload**:

```
SMB
...
```

### 分析结论

- 文件名包含 "adduser"，推断为用户添加攻击
- 端口 445 确认为 SMB
- Payload 包含 SMB 命令
- 横向移动方向: 源主机 → 目标主机

**结果**: `172.16.13.42,172.16.13.41,smb-adduser.pcap`

---

## 示例 4: 多候选流分析

**场景**: 复杂流量，存在多个候选流

**文件**: `complex-traffic.pcap`

### 步骤 1: 列出所有流

```bash
python scripts/pcap_tools.py list complex-traffic.pcap --top 10
```

**输出**:
```
# IP 流列表 (Top 10)

| 源 IP | 目的 IP | 字节数 | 数据包 | 端口 |
|-------|---------|--------|--------|------|
| 192.168.1.10 | 192.168.1.20 | 5000 | 120 | 49152->80 |
| 192.168.1.10 | 192.168.1.30 | 1000 | 50 | 54321->22 |
| 192.168.1.10 | 192.168.1.40 | 500 | 30 | 50123->445 |
```

### 步骤 2: 分析流量特征

| 流 | 字节数 | 端口 | 可能协议 |
|---|-------|------|---------|
| 192.168.1.10 -> 192.168.1.20 | 5000 | 49152->80 | HTTP |
| 192.168.1.10 -> 192.168.1.30 | 1000 | 54321->22 | SSH |
| 192.168.1.10 -> 192.168.1.40 | 500 | 50123->445 | SMB |

### 步骤 3: 提取 payload 确认主流量

```bash
# 分析 HTTP 流（指定端口 80）
python scripts/pcap_tools.py extract complex-traffic.pcap 192.168.1.10 192.168.1.20 --dst-port 80

# 或者不指定端口
python scripts/pcap_tools.py extract complex-traffic.pcap 192.168.1.10 192.168.1.20
```

**输出**:
```
# 找到 1 个 TCP 流

## 流 1: `192.168.1.10:49152` → `192.168.1.20:80`

### 数据包 1

- **SEQ**: `1000`
- **ACK**: `0`

**Payload**:

```
GET /download/payload.exe HTTP/1.1
User-Agent: certutil
```
```

### 分析结论

- HTTP 流量字节数最多，包含恶意文件下载
- URI `/download/payload.exe` 表明是攻击载荷下载
- `User-Agent: certutil` 确认攻击工具

**结果**: `192.168.1.10,192.168.1.20,complex-traffic.pcap`

---

## 分析技巧总结

### 1. 端口快速识别

| 端口 | 协议 | 常见用途 |
|------|------|---------|
| 80, 8080 | HTTP | Web 流量 |
| 443 | HTTPS | 加密 Web |
| 22 | SSH | 远程登录 |
| 3389 | RDP | 远程桌面 |
| 445 | SMB | 文件共享 |
| 137-139 | NetBIOS | Windows 网络（通常是背景流量） |

### 2. 流量选择优先级

1. **字节数最多** - 通常是核心流量
2. **有应用层协议** - HTTP/SMB 比 TCP 更明确
3. **非常规端口** - 可能是自定义 C2 通道

### 3. Payload 分析要点

- **HTTP**: 查看 URI、User-Agent、Host
- **SMB**: 查看共享名、命令
- **加密流量**: 无法分析 payload，通过端口和方向判断
